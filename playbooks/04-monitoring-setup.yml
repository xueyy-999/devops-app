---
- name: 部署容器化监控系统
  hosts: monitoring_nodes
  become: yes
  vars:
    prometheus_version: "v2.45.0"
    grafana_version: "10.0.0"
    alertmanager_version: "v0.25.0"
    node_exporter_version: "v1.6.1"
    prometheus_port: 9090
    grafana_port: 3000
    alertmanager_port: 9093
    node_exporter_port: 9100
    docker_host_socket: "unix://var/run/docker.sock"

  module_defaults:
    community.docker.docker_container:
      docker_host: "{{ docker_host_socket }}"

  environment:
    DOCKER_HOST: "{{ docker_host_socket }}"

  tasks:
    - name: 移除可能残留的同名监控容器
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
      loop:
        - prometheus
        - grafana
        - alertmanager
        - node-exporter

    - name: 移除Grafana仓库文件
      file:
        path: /etc/yum.repos.d/grafana.repo
        state: absent
      ignore_errors: true

    - name: 停止并禁用本机已安装的Prometheus/Grafana/Node Exporter/Alertmanager服务
      systemd:
        name: "{{ item }}"
        state: stopped
        enabled: no
      loop:
        - prometheus
        - grafana-server
        - node_exporter
        - alertmanager
      ignore_errors: true

    - name: 释放占用端口 9090/3000/9093/9100（若有）
      shell: |
        for p in 9090 3000 9093 9100; do
          for pid in $(ss -lntp | grep ":${p} " | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' | sort -u); do
            kill -9 "$pid" || true
          done
        done
      args:
        executable: /bin/bash
      ignore_errors: true

    - name: 启用CRB仓库（CentOS Stream 9）
      command: dnf config-manager --set-enabled crb
      register: crb_result
      changed_when: crb_result.rc == 0
      failed_when: false

    - name: 刷新DNF缓存
      command: dnf -y makecache
      changed_when: false

    - name: 确保Docker已安装并在运行
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: 安装python3与pip
      dnf:
        name:
          - python3
          - python3-pip
        state: present
        update_cache: yes

    - name: 移除旧版 docker-py
      pip:
        name: docker-py
        state: absent
        executable: pip3

    - name: 安装Docker SDK 与依赖（修复 http+docker 兼容性）
      pip:
        name:
          - docker==6.1.3
          - requests==2.31.0
          - 'urllib3<2.0.0'
        state: present
        executable: pip3

    - name: 创建监控目录
      file:
        path: "{{ item }}"
        state: directory
        mode: '0775'
      loop:
        - /opt/monitoring
        - /opt/monitoring/prometheus
        - /opt/monitoring/grafana
        - /opt/monitoring/alertmanager
        - /opt/monitoring/configs

    - name: 设置Prometheus/Alertmanager数据目录权限
      shell: chown -R 65534:65534 /opt/monitoring/prometheus /opt/monitoring/alertmanager || true
      args:
        executable: /bin/bash

    - name: 设置Grafana数据目录权限
      shell: |
        mkdir -p /opt/monitoring/grafana/plugins
        chown -R 472:472 /opt/monitoring/grafana || true
      args:
        executable: /bin/bash

    - name: 渲染Prometheus配置
      template:
        src: ../templates/prometheus.yml.j2
        dest: /opt/monitoring/configs/prometheus.yml
        mode: '0644'

    - name: 生成Alertmanager配置
      copy:
        content: |
          global:
          
          route:
            group_by: ['alertname']
            group_wait: 10s
            group_interval: 10s
            repeat_interval: 1h
            receiver: 'default'
          
          receivers:
          - name: 'default'
        dest: /opt/monitoring/configs/alertmanager.yml
        mode: '0644'

    - name: 生成Grafana配置
      copy:
        content: |
          [server]
          domain = localhost
          root_url = http://localhost:3000/
          
          [security]
          admin_user = admin
          admin_password = admin
          
          [users]
          allow_sign_up = false
        dest: /opt/monitoring/configs/grafana.ini
        mode: '0644'

    - name: 启动Prometheus容器
      community.docker.docker_container:
        name: prometheus
        image: prom/prometheus:{{ prometheus_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ prometheus_port }}:9090"
        volumes:
          - /opt/monitoring/configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
          - /opt/monitoring/prometheus:/prometheus
        command: >
          --config.file=/etc/prometheus/prometheus.yml
          --storage.tsdb.path=/prometheus
          --web.enable-lifecycle

    - name: 启动Alertmanager容器
      community.docker.docker_container:
        name: alertmanager
        image: prom/alertmanager:{{ alertmanager_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ alertmanager_port }}:9093"
        volumes:
          - /opt/monitoring/configs/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
          - /opt/monitoring/alertmanager:/alertmanager
        command: >
          --config.file=/etc/alertmanager/alertmanager.yml
          --storage.path=/alertmanager

    - name: 启动Grafana容器
      community.docker.docker_container:
        name: grafana
        image: grafana/grafana:{{ grafana_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ grafana_port }}:3000"
        volumes:
          - /opt/monitoring/configs/grafana.ini:/etc/grafana/grafana.ini:ro
          - /opt/monitoring/grafana:/var/lib/grafana
        env:
          GF_SECURITY_ADMIN_PASSWORD: "admin"

    - name: 启动Node Exporter容器
      community.docker.docker_container:
        name: node-exporter
        image: prom/node-exporter:{{ node_exporter_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ node_exporter_port }}:9100"
        volumes:
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        command: >
          --path.procfs=/host/proc
          --path.rootfs=/rootfs
          --path.sysfs=/host/sys
          --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)

    - name: 等待服务启动
      wait_for:
        port: "{{ item }}"
        host: 127.0.0.1
        delay: 5
        timeout: 180
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"
        - "{{ alertmanager_port }}"
        - "{{ node_exporter_port }}"

    - name: 显示访问信息
      debug:
        msg: |
          监控系统部署完成！
          - Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}
          - Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}  (admin/admin)
          - Alertmanager: http://{{ ansible_default_ipv4.address }}:{{ alertmanager_port }}
          - Node Exporter: http://{{ ansible_default_ipv4.address }}:{{ node_exporter_port }}

