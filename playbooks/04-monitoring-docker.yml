---
- name: 部署容器化监控系统
  hosts: monitoring_nodes
  become: yes
  vars:
    prometheus_version: "2.45.0"
    grafana_version: "10.0.0"
    alertmanager_version: "0.25.0"
    node_exporter_version: "1.6.1"
    prometheus_port: 9090
    grafana_port: 3000
    alertmanager_port: 9093
    node_exporter_port: 9100

  tasks:
    - name: 创建监控目录
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/monitoring
        - /opt/monitoring/prometheus
        - /opt/monitoring/grafana
        - /opt/monitoring/alertmanager
        - /opt/monitoring/configs

    - name: 创建Prometheus配置
      template:
        src: ../templates/prometheus.yml.j2
        dest: /opt/monitoring/configs/prometheus.yml
        mode: '0644'

    - name: 创建Alertmanager配置
      copy:
        content: |
          global:
            smtp_smarthost: 'localhost:587'
            smtp_from: 'alertmanager@example.com'
          
          route:
            group_by: ['alertname']
            group_wait: 10s
            group_interval: 10s
            repeat_interval: 1h
            receiver: 'web.hook'
          
          receivers:
          - name: 'web.hook'
            webhook_configs:
            - url: 'http://127.0.0.1:5001/'
        dest: /opt/monitoring/configs/alertmanager.yml
        mode: '0644'

    - name: 创建Grafana配置
      copy:
        content: |
          [server]
          domain = localhost
          root_url = http://localhost:3000/
          
          [security]
          admin_user = admin
          admin_password = admin
          
          [users]
          allow_sign_up = false
        dest: /opt/monitoring/configs/grafana.ini
        mode: '0644'

    - name: 启动Prometheus容器
      docker_container:
        name: prometheus
        image: prom/prometheus:{{ prometheus_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ prometheus_port }}:9090"
        volumes:
          - /opt/monitoring/configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
          - /opt/monitoring/prometheus:/prometheus
        command: >
          --config.file=/etc/prometheus/prometheus.yml
          --storage.tsdb.path=/prometheus
          --web.console.libraries=/etc/prometheus/console_libraries
          --web.console.templates=/etc/prometheus/consoles
          --web.enable-lifecycle

    - name: 启动Alertmanager容器
      docker_container:
        name: alertmanager
        image: prom/alertmanager:{{ alertmanager_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ alertmanager_port }}:9093"
        volumes:
          - /opt/monitoring/configs/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
          - /opt/monitoring/alertmanager:/alertmanager
        command: >
          --config.file=/etc/alertmanager/alertmanager.yml
          --storage.path=/alertmanager
          --web.external-url=http://localhost:9093

    - name: 启动Grafana容器
      docker_container:
        name: grafana
        image: grafana/grafana:{{ grafana_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ grafana_port }}:3000"
        volumes:
          - /opt/monitoring/configs/grafana.ini:/etc/grafana/grafana.ini:ro
          - /opt/monitoring/grafana:/var/lib/grafana
        env:
          GF_SECURITY_ADMIN_PASSWORD: "admin"

    - name: 启动Node Exporter容器
      docker_container:
        name: node-exporter
        image: prom/node-exporter:{{ node_exporter_version }}
        state: started
        restart_policy: always
        ports:
          - "{{ node_exporter_port }}:9100"
        volumes:
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        command: >
          --path.procfs=/host/proc
          --path.rootfs=/rootfs
          --path.sysfs=/host/sys
          --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)

    - name: 等待服务启动
      wait_for:
        port: "{{ item }}"
        host: localhost
        delay: 10
        timeout: 60
      loop:
        - "{{ prometheus_port }}"
        - "{{ grafana_port }}"
        - "{{ alertmanager_port }}"
        - "{{ node_exporter_port }}"

    - name: 显示访问信息
      debug:
        msg: |
          监控系统部署完成！
          
          访问地址：
          - Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}
          - Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }} (admin/admin)
          - Alertmanager: http://{{ ansible_default_ipv4.address }}:{{ alertmanager_port }}
          - Node Exporter: http://{{ ansible_default_ipv4.address }}:{{ node_exporter_port }}
          
          容器状态检查：
          docker ps | grep -E "(prometheus|grafana|alertmanager|node-exporter)"
