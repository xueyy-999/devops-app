---
# ç³»ç»ŸéªŒè¯å’Œå¥åº·æ£€æŸ¥
- name: éªŒè¯ç³»ç»Ÿéƒ¨ç½²
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    verification_timeout: 300
    health_check_interval: 30

  tasks:
    # 1. éªŒè¯ç³»ç»ŸåŸºç¡€ç¯å¢ƒ
    - name: éªŒè¯ç³»ç»ŸåŸºç¡€ç¯å¢ƒ
      block:
        - name: æ£€æŸ¥ç³»ç»Ÿæ—¶é—´
          command: date
          register: system_time
          changed_when: false

        - name: æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
          command: uptime
          register: system_load
          changed_when: false

        - name: æ£€æŸ¥å†…å­˜ä½¿ç”¨
          command: free -h
          register: memory_usage
          changed_when: false

        - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨
          command: df -h
          register: disk_usage
          changed_when: false

        - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          debug:
            msg:
              - "ç³»ç»Ÿæ—¶é—´: {{ system_time.stdout }}"
              - "ç³»ç»Ÿè´Ÿè½½: {{ system_load.stdout }}"
              - "å†…å­˜ä½¿ç”¨: {{ memory_usage.stdout_lines[1] }}"
              - "ç£ç›˜ä½¿ç”¨: {{ disk_usage.stdout_lines[1:] }}"

    # 2. éªŒè¯DockeræœåŠ¡
    - name: éªŒè¯DockeræœåŠ¡
      block:
        - name: æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
          systemd:
            name: docker
          register: docker_status

        - name: æ£€æŸ¥Dockerç‰ˆæœ¬
          command: docker --version
          register: docker_version
          changed_when: false

        - name: æ£€æŸ¥Dockerå®¹å™¨
          command: docker ps
          register: docker_containers
          changed_when: false

        - name: æ˜¾ç¤ºDockerä¿¡æ¯
          debug:
            msg:
              - "DockerçŠ¶æ€: {{ docker_status.status.ActiveState }}"
              - "Dockerç‰ˆæœ¬: {{ docker_version.stdout }}"
              - "è¿è¡Œå®¹å™¨: {{ docker_containers.stdout_lines[1:] | length }}"

    # 3. éªŒè¯Kubernetesé›†ç¾¤
    - name: éªŒè¯Kubernetesé›†ç¾¤
      block:
        - name: æ£€æŸ¥kubeletæœåŠ¡çŠ¶æ€
          systemd:
            name: kubelet
          register: kubelet_status

        - name: æ£€æŸ¥KubernetesèŠ‚ç‚¹
          shell: kubectl get nodes -o wide
          register: k8s_nodes
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ£€æŸ¥Kubernetes PodçŠ¶æ€
          shell: kubectl get pods --all-namespaces
          register: k8s_pods
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ£€æŸ¥KubernetesæœåŠ¡çŠ¶æ€
          shell: kubectl get services --all-namespaces
          register: k8s_services
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ˜¾ç¤ºKubernetesä¿¡æ¯
          debug:
            msg:
              - "kubeletçŠ¶æ€: {{ kubelet_status.status.ActiveState }}"
              - "èŠ‚ç‚¹çŠ¶æ€: {{ k8s_nodes.stdout_lines[1:] if k8s_nodes is defined else 'N/A' }}"
              - "PodçŠ¶æ€: {{ k8s_pods.stdout_lines[1:] if k8s_pods is defined else 'N/A' }}"
              - "æœåŠ¡çŠ¶æ€: {{ k8s_services.stdout_lines[1:] if k8s_services is defined else 'N/A' }}"

    # 4. éªŒè¯ç›‘æ§æœåŠ¡
    - name: éªŒè¯ç›‘æ§æœåŠ¡
      block:
        - name: æ£€æŸ¥PrometheusæœåŠ¡
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}/api/v1/query?query=up"
            method: GET
            status_code: 200
          register: prometheus_status
          when: inventory_hostname in groups['monitoring_nodes']

        - name: æ£€æŸ¥GrafanaæœåŠ¡
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}/api/health"
            method: GET
            status_code: 200
          register: grafana_status
          when: inventory_hostname in groups['monitoring_nodes']

        - name: æ£€æŸ¥AlertmanageræœåŠ¡
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ alertmanager_port }}/api/v1/status"
            method: GET
            status_code: 200
          register: alertmanager_status
          when: inventory_hostname in groups['monitoring_nodes']

        - name: æ˜¾ç¤ºç›‘æ§æœåŠ¡ä¿¡æ¯
          debug:
            msg:
              - "PrometheusçŠ¶æ€: {{ prometheus_status.status if prometheus_status is defined else 'N/A' }}"
              - "GrafanaçŠ¶æ€: {{ grafana_status.status if grafana_status is defined else 'N/A' }}"
              - "AlertmanagerçŠ¶æ€: {{ alertmanager_status.status if alertmanager_status is defined else 'N/A' }}"

    # 5. éªŒè¯CI/CDæœåŠ¡
    - name: éªŒè¯CI/CDæœåŠ¡
      block:
        - name: è®¡ç®—GitLab APIåœ°å€
          set_fact:
            gitlab_api_primary: "http://{{ ansible_default_ipv4.address }}{% if gitlab_port != 80 %}:{{ gitlab_port }}{% endif %}/api/v4/version"
            gitlab_api_alt: "http://{{ ansible_default_ipv4.address }}{% if gitlab_port != 80 %}:{{ gitlab_port }}{% endif %}/gitlab/api/v4/version"
          when: inventory_hostname in groups['cicd_nodes']

        - name: è®¡ç®—GitLabæ ¹åœ°å€
          set_fact:
            gitlab_root_url: "http://{{ ansible_default_ipv4.address }}{% if gitlab_port != 80 %}:{{ gitlab_port }}{% endif %}/"
          when: inventory_hostname in groups['cicd_nodes']

        - name: è®¡ç®—GitLabå†…ç½®åœ°å€ï¼ˆæœ¬æœºå›ç¯ï¼‰
          set_fact:
            gitlab_internal_url: "http://127.0.0.1:8081/users/sign_in"
          when: inventory_hostname in groups['cicd_nodes']

        - name: GitLabæ ¹è·¯å¾„æ¢æ´»ï¼ˆé€šè¿‡åä»£ï¼‰
          uri:
            url: "{{ gitlab_root_url }}"
            method: GET
            follow_redirects: all
            validate_certs: no
            status_code:
              - 200
              - 302
          register: gitlab_root_status
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes']

        - name: GitLabæœ¬æœºæ¢æ´»ï¼ˆå†…ç½®Nginx 8081ï¼‰
          uri:
            url: "{{ gitlab_internal_url }}"
            method: GET
            follow_redirects: all
            validate_certs: no
            status_code:
              - 200
              - 302
              - 401
              - 403
          register: gitlab_internal_status
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes']

        - name: GitLabæ¢æ´»ï¼ˆä¸»è·¯å¾„ï¼‰
          uri:
            url: "{{ gitlab_api_primary }}"
            method: GET
            follow_redirects: all
            validate_certs: no
          register: gitlab_status
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes']

        - name: GitLabæ¢æ´»ï¼ˆå­è·¯å¾„å›é€€ï¼‰
          uri:
            url: "{{ gitlab_api_alt }}"
            method: GET
            follow_redirects: all
            validate_certs: no
          register: gitlab_status_alt
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes'] and (gitlab_status.status | default(0)) != 200

        - name: æ˜¾ç¤ºGitLabè¯¦ç»†æ£€æŸ¥ç»“æœ
          debug:
            msg:
              - "========== GitLabè¿æ¥æ£€æŸ¥ç»“æœ =========="
              - "Rootè·¯å¾„ ({{ gitlab_root_url }}): {{ gitlab_root_status.status | default('FAILED') }}"
              - "å†…éƒ¨è·¯å¾„ ({{ gitlab_internal_url }}): {{ gitlab_internal_status.status | default('FAILED') }}"
              - "APIä¸»è·¯å¾„ ({{ gitlab_api_primary }}): {{ gitlab_status.status | default('FAILED') }}"
              - "APIå¤‡ç”¨è·¯å¾„ ({{ gitlab_api_alt }}): {{ gitlab_status_alt.status | default('FAILED') }}"
              - "========================================="
          when: inventory_hostname in groups['cicd_nodes']

        - name: æ–­è¨€GitLabå¯è¾¾
          assert:
            that:
              - ((gitlab_root_status.status | default(0)) in [200, 302]) or ((gitlab_internal_status.status | default(0)) in [200, 302, 401, 403]) or (gitlab_status.status | default(0)) in [200, 401] or (gitlab_status_alt.status | default(0)) in [200, 401]
            fail_msg: |
              âŒ GitLab æ£€æŸ¥å¤±è´¥ï¼
              
              æ£€æŸ¥ç»“æœï¼š
                - Rootè·¯å¾„: {{ gitlab_root_status.status | default('N/A') }}
                - å†…éƒ¨è·¯å¾„: {{ gitlab_internal_status.status | default('N/A') }}  
                - APIä¸»è·¯å¾„: {{ gitlab_status.status | default('N/A') }}
                - APIå¤‡ç”¨è·¯å¾„: {{ gitlab_status_alt.status | default('N/A') }}
              
              ğŸ” å¯èƒ½çš„åŸå› ï¼š
                1. GitLabæœåŠ¡æœªå®Œå…¨å¯åŠ¨ï¼ˆæœ€å¸¸è§ï¼‰
                2. PostgreSQLæ•°æ®åº“è¿æ¥å¤±è´¥
                3. RedisæœåŠ¡æœªè¿è¡Œ
                4. Nginxåå‘ä»£ç†é…ç½®é”™è¯¯
                5. ç£ç›˜ç©ºé—´æˆ–å†…å­˜ä¸è¶³
              
              ğŸš€ ç«‹å³è¯Šæ–­ï¼š
                ssh {{ ansible_host }}
                cd /root/cloud-native-devops-platform
                ./scripts/gitlab-diagnosis.sh
              
              ğŸ“– è¯¦ç»†æ’æŸ¥æŒ‡å—ï¼š
                æŸ¥çœ‹ GITLAB_TROUBLESHOOTING.md æ–‡ä»¶
              
              â±ï¸  å¦‚æœGitLabåˆšå¯åŠ¨ï¼Œè¯·ç­‰å¾…5-10åˆ†é’Ÿåé‡è¯•
          when: inventory_hostname in groups['cicd_nodes']

        - name: æ£€æŸ¥JenkinsæœåŠ¡
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ jenkins_port }}/api/json"
            method: GET
            status_code: 200
            follow_redirects: all
            validate_certs: no
          register: jenkins_status
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes']

        - name: æ£€æŸ¥HarboræœåŠ¡
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:5000/api/v2.0/systeminfo"
            method: GET
            status_code:
              - 200
              - 308
              - 301
              - 302
            follow_redirects: safe
            validate_certs: no
          register: harbor_status
          failed_when: false
          when: inventory_hostname in groups['cicd_nodes']

        - name: æ˜¾ç¤ºCI/CDæœåŠ¡ä¿¡æ¯
          debug:
            msg:
              - "GitLabçŠ¶æ€: {{ gitlab_status.status if gitlab_status is defined else 'N/A' }}"
              - "JenkinsçŠ¶æ€: {{ jenkins_status.status if jenkins_status is defined else 'N/A' }}"
              - "HarborçŠ¶æ€: {{ harbor_status.status if harbor_status is defined else 'N/A' }}"

    # 6. éªŒè¯åº”ç”¨éƒ¨ç½²
    - name: éªŒè¯åº”ç”¨éƒ¨ç½²
      block:
        - name: æ£€æŸ¥åº”ç”¨PodçŠ¶æ€
          shell: kubectl get pods -n {{ app_namespace }} -l app={{ app_name }}
          register: app_pods
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ£€æŸ¥åº”ç”¨æœåŠ¡çŠ¶æ€
          shell: kubectl get services -n {{ app_namespace }} -l app={{ app_name }}
          register: app_services
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ£€æŸ¥åº”ç”¨IngressçŠ¶æ€
          shell: kubectl get ingress -n {{ app_namespace }} -l app={{ app_name }}
          register: app_ingress
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ£€æŸ¥åº”ç”¨HPAçŠ¶æ€
          shell: kubectl get hpa -n {{ app_namespace }} -l app={{ app_name }}
          register: app_hpa
          changed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
          debug:
            msg:
              - "åº”ç”¨PodçŠ¶æ€: {{ app_pods.stdout_lines[1:] if app_pods is defined else 'N/A' }}"
              - "åº”ç”¨æœåŠ¡çŠ¶æ€: {{ app_services.stdout_lines[1:] if app_services is defined else 'N/A' }}"
              - "åº”ç”¨IngressçŠ¶æ€: {{ app_ingress.stdout_lines[1:] if app_ingress is defined else 'N/A' }}"
              - "åº”ç”¨HPAçŠ¶æ€: {{ app_hpa.stdout_lines[1:] if app_hpa is defined else 'N/A' }}"

    # 7. æ€§èƒ½æµ‹è¯•
    - name: æ€§èƒ½æµ‹è¯•
      block:
        - name: æµ‹è¯•åº”ç”¨å“åº”æ—¶é—´
          uri:
            url: "http://{{ ansible_default_ipv4.address }}/"
            method: GET
            timeout: 10
            status_code:
              - 200
              - 302
              - 500
          register: app_response
          failed_when: false
          when: inventory_hostname in groups['control_nodes']

        - name: æµ‹è¯•ç›‘æ§æœåŠ¡å“åº”æ—¶é—´
          uri:
            url: "http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}/"
            method: GET
            timeout: 10
          register: prometheus_response
          when: inventory_hostname in groups['monitoring_nodes']

        - name: æ˜¾ç¤ºæ€§èƒ½æµ‹è¯•ç»“æœ
          debug:
            msg:
              - "åº”ç”¨å“åº”æ—¶é—´: {{ app_response.elapsed if app_response is defined else 'N/A' }}ç§’"
              - "Prometheuså“åº”æ—¶é—´: {{ prometheus_response.elapsed if prometheus_response is defined else 'N/A' }}ç§’"

    # 8. ç”ŸæˆéªŒè¯æŠ¥å‘Š
    - name: ç”ŸæˆéªŒè¯æŠ¥å‘Š
      template:
        src: ../templates/verification-report.j2
        dest: /tmp/verification-report.md
        mode: '0644'

    - name: æ˜¾ç¤ºéªŒè¯æŠ¥å‘Š
      debug:
        msg: "éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ: /tmp/verification-report.md"

  post_tasks:
    - name: æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€æ€»ç»“
      debug:
        msg:
          - "=== ç³»ç»ŸéªŒè¯å®Œæˆ ==="
          - "æ§åˆ¶èŠ‚ç‚¹: {{ groups['control_nodes'] | join(', ') }}"
          - "è®¡ç®—èŠ‚ç‚¹: {{ groups['compute_nodes'] | join(', ') }}"
          - "ç›‘æ§èŠ‚ç‚¹: {{ groups['monitoring_nodes'] | join(', ') }}"
          - "CI/CDèŠ‚ç‚¹: {{ groups['cicd_nodes'] | join(', ') }}"
          - "åº”ç”¨è®¿é—®åœ°å€: http://{{ app_domain }}"
          - "ç›‘æ§åœ°å€: http://{{ ansible_default_ipv4.address }}:{{ prometheus_port }}"
          - "ä»ªè¡¨æ¿åœ°å€: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
