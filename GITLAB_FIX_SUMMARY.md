# GitLab 500 é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ¯ å·²ä¿®å¤çš„é—®é¢˜

### 1. âœ… é…ç½®å†²çªä¿®å¤
**é—®é¢˜ï¼š** `playbooks/05-cicd-setup.yml` ä¸­ `gitlab_port: 8081`ï¼Œä½† `inventory/single-node.yml` ä¸­ `gitlab_port: 80`

**ä¿®å¤ï¼š** åœ¨ `inventory/single-node.yml` ä¸­æ·»åŠ äº†æ˜ç¡®çš„é…ç½®æ³¨é‡Šï¼š
```yaml
# CI/CDé…ç½®
gitlab_port: 80  # å¤–éƒ¨Nginxåä»£ç«¯å£ï¼ˆGitLabå†…ç½®Nginxåœ¨8081ï¼‰
gitlab_internal_port: 8081  # GitLabå†…ç½®Nginxç«¯å£
jenkins_port: 8080
harbor_port: 80  # å¤–éƒ¨Nginxåä»£ç«¯å£ï¼ˆHarborå®é™…åœ¨5000ï¼‰
harbor_internal_port: 5000  # Harborå®é™…ç«¯å£
```

### 2. âœ… URLæ„å»ºé€»è¾‘ä¿®å¤
**é—®é¢˜ï¼š** éªŒè¯è„šæœ¬æ„å»ºURLä¸º `http://192.168.76.141:80/...`ï¼ˆä¸æ­£ç¡®ï¼‰

**ä¿®å¤ï¼š** åœ¨ `playbooks/07-verification.yml` ä¸­ä½¿ç”¨æ¡ä»¶åˆ¤æ–­ï¼š
```yaml
gitlab_api_primary: "http://{{ ansible_default_ipv4.address }}{% if gitlab_port != 80 %}:{{ gitlab_port }}{% endif %}/api/v4/version"
```
ç°åœ¨ä¼šç”Ÿæˆæ­£ç¡®çš„URLï¼š`http://192.168.76.141/api/v4/version`

### 3. âœ… æ·»åŠ è¯¦ç»†è¯Šæ–­ä¿¡æ¯
**æ–°å¢ï¼š** éªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè¯Šæ–­å»ºè®®

### 4. âœ… åˆ›å»ºè¯Šæ–­å·¥å…·
**æ–°å¢ï¼š** `scripts/gitlab-diagnosis.sh` - å®Œæ•´çš„GitLabè¯Šæ–­è„šæœ¬

### 5. âœ… åˆ›å»ºæ’æŸ¥æ–‡æ¡£
**æ–°å¢ï¼š** `GITLAB_TROUBLESHOOTING.md` - è¯¦ç»†çš„é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸš€ ç«‹å³æ‰§è¡Œçš„æ­¥éª¤

### æ­¥éª¤1ï¼šä¸Šä¼ ä¿®å¤çš„æ–‡ä»¶åˆ°è™šæ‹Ÿæœº

```bash
# åœ¨Windowsä¸Šï¼ˆPowerShellï¼‰
cd D:\3

# ä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶
scp inventory/single-node.yml root@192.168.76.141:/root/cloud-native-devops-platform/inventory/
scp playbooks/07-verification.yml root@192.168.76.141:/root/cloud-native-devops-platform/playbooks/
scp scripts/gitlab-diagnosis.sh root@192.168.76.141:/root/cloud-native-devops-platform/scripts/
scp GITLAB_TROUBLESHOOTING.md root@192.168.76.141:/root/cloud-native-devops-platform/
```

### æ­¥éª¤2ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

```bash
# SSHåˆ°è™šæ‹Ÿæœº
ssh root@192.168.76.141

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/cloud-native-devops-platform

# ç»™è¯Šæ–­è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/gitlab-diagnosis.sh

# è¿è¡Œè¯Šæ–­
./scripts/gitlab-diagnosis.sh
```

### æ­¥éª¤3ï¼šæ ¹æ®è¯Šæ–­ç»“æœä¿®å¤

è¯Šæ–­è„šæœ¬ä¼šæ£€æŸ¥10ä¸ªæ–¹é¢ï¼Œå¹¶ç»™å‡ºå…·ä½“å»ºè®®ã€‚å¸¸è§æƒ…å†µï¼š

#### æƒ…å†µAï¼šPostgreSQLæœªè¿è¡Œ
```bash
systemctl start postgresql
systemctl enable postgresql
gitlab-ctl restart
```

#### æƒ…å†µBï¼šRedisæœªè¿è¡Œ
```bash
systemctl start redis
systemctl enable redis
gitlab-ctl restart
```

#### æƒ…å†µCï¼šGitLabæœåŠ¡å¼‚å¸¸
```bash
# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
gitlab-ctl status

# é‡å¯GitLab
gitlab-ctl restart

# æŸ¥çœ‹æ—¥å¿—
gitlab-ctl tail
```

#### æƒ…å†µDï¼šNginxé…ç½®é”™è¯¯
```bash
# æµ‹è¯•Nginxé…ç½®
nginx -t

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# é‡å¯Nginx
systemctl restart nginx
```

### æ­¥éª¤4ï¼šé‡æ–°è¿è¡ŒéªŒè¯è„šæœ¬

```bash
# ç­‰å¾…æ‰€æœ‰æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆé‡è¦ï¼ï¼‰
sleep 60

# è¿è¡ŒéªŒè¯
ansible-playbook -i inventory/single-node.yml playbooks/07-verification.yml
```

## ğŸ” å¿«é€Ÿæ£€æŸ¥å‘½ä»¤

```bash
# 1. æ£€æŸ¥æ‰€æœ‰å…³é”®æœåŠ¡
systemctl status postgresql redis nginx gitlab-runsvdir.service

# 2. æ£€æŸ¥ç«¯å£
netstat -tuln | grep -E ':80|:8081|:5432|:6379'

# 3. æµ‹è¯•GitLabè¿æ¥
curl -I http://127.0.0.1:8081/
curl -I http://192.168.76.141/
curl -I http://192.168.76.141/api/v4/version

# 4. æŸ¥çœ‹GitLabçŠ¶æ€
gitlab-ctl status

# 5. æŸ¥çœ‹æœ€è¿‘é”™è¯¯
tail -50 /var/log/gitlab/gitlab-rails/production.log | grep ERROR
```

## ğŸ“Š GitLabæ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨è¯·æ±‚: http://192.168.76.141/                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Nginx (80ç«¯å£)       â”‚  â† å¤–éƒ¨åå‘ä»£ç†
          â”‚  /etc/nginx/nginx.confâ”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ proxy_pass
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  GitLabå†…ç½®Nginx (8081ç«¯å£)   â”‚  â† ä»…ç›‘å¬127.0.0.1
          â”‚  /var/opt/gitlab/nginx        â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  GitLabåº”ç”¨ (Puma/Unicorn)    â”‚
          â”‚  /opt/gitlab/embedded/service â”‚
          â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ PostgreSQL   â”‚      â”‚   Redis     â”‚
    â”‚ (5432ç«¯å£)   â”‚      â”‚  (6379ç«¯å£) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéªŒè¯è„šæœ¬å¤±è´¥ä½†æ‰‹åŠ¨curlå¯ä»¥ï¼Ÿ
**A:** å¯èƒ½æ˜¯ï¼š
- éªŒè¯è„šæœ¬è¿è¡Œæ—¶GitLabè¿˜æœªå®Œå…¨å¯åŠ¨
- URLæ„å»ºæœ‰è¯¯ï¼ˆå·²ä¿®å¤ï¼‰
- DNSæˆ–ç½‘ç»œé…ç½®é—®é¢˜

### Q2: 500é”™è¯¯æœ€å¸¸è§çš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ
**A:** æŒ‰é¢‘ç‡æ’åºï¼š
1. **GitLabæœªå®Œå…¨å¯åŠ¨**ï¼ˆéœ€è¦ç­‰å¾…5-10åˆ†é’Ÿï¼‰
2. **PostgreSQLè¿æ¥å¤±è´¥**
3. **Redisè¿æ¥å¤±è´¥**
4. **ç£ç›˜ç©ºé—´ä¸è¶³**
5. **å†…å­˜ä¸è¶³**

### Q3: å¦‚ä½•ç¡®è®¤GitLabå®Œå…¨å¯åŠ¨ï¼Ÿ
**A:** è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿”å›200è¡¨ç¤ºå°±ç»ªï¼š
```bash
curl -I http://127.0.0.1:8081/-/readiness
```

### Q4: éªŒè¯è„šæœ¬åº”è¯¥ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Ÿ
**A:** åœ¨GitLabéƒ¨ç½²å®Œæˆåï¼Œè‡³å°‘ç­‰å¾…ï¼š
- æœ€å°‘ï¼š5åˆ†é’Ÿ
- æ¨èï¼š10åˆ†é’Ÿ
- é¦–æ¬¡å®‰è£…ï¼š15-20åˆ†é’Ÿ

### Q5: å¦‚ä½•æŸ¥çœ‹GitLabå¯åŠ¨è¿›åº¦ï¼Ÿ
**A:** ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰ç»„ä»¶çŠ¶æ€
gitlab-ctl status

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
gitlab-ctl tail

# å¾ªç¯æ£€æŸ¥å°±ç»ªçŠ¶æ€
watch -n 5 'curl -I http://127.0.0.1:8081/-/readiness'
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | å½±å“ |
|------|---------|------|
| `inventory/single-node.yml` | æ·»åŠ ç«¯å£é…ç½®æ³¨é‡Šï¼Œæ–°å¢ `gitlab_internal_port` | âœ… é…ç½®æ›´æ¸…æ™° |
| `playbooks/07-verification.yml` | ä¿®å¤URLæ„å»ºé€»è¾‘ï¼Œæ·»åŠ è¯¦ç»†é”™è¯¯ä¿¡æ¯ | âœ… éªŒè¯æ›´å‡†ç¡® |
| `scripts/gitlab-diagnosis.sh` | æ–°å»ºè¯Šæ–­è„šæœ¬ | âœ… å¿«é€Ÿå®šä½é—®é¢˜ |
| `GITLAB_TROUBLESHOOTING.md` | æ–°å»ºæ’æŸ¥æ–‡æ¡£ | âœ… è¯¦ç»†è§£å†³æ–¹æ¡ˆ |

## ğŸ“ å­¦åˆ°çš„ç»éªŒ

1. **ç«¯å£é…ç½®è¦ä¸€è‡´**ï¼šplaybookå˜é‡å’Œinventoryå˜é‡éœ€è¦åŒ¹é…
2. **URLæ„å»ºè¦æ³¨æ„**ï¼š80ç«¯å£ä¸éœ€è¦åœ¨URLä¸­æ˜¾å¼æŒ‡å®š
3. **å¯åŠ¨éœ€è¦æ—¶é—´**ï¼šGitLabéœ€è¦è¶³å¤Ÿçš„å¯åŠ¨æ—¶é—´
4. **è¯Šæ–­å·¥å…·é‡è¦**ï¼šè‡ªåŠ¨åŒ–è¯Šæ–­è„šæœ¬å¯ä»¥èŠ‚çœå¤§é‡æ—¶é—´
5. **æ–‡æ¡£å¾ˆå…³é”®**ï¼šè¯¦ç»†çš„æ’æŸ¥æ–‡æ¡£å¯ä»¥å¿«é€Ÿè§£å†³é—®é¢˜

## ğŸ“ ä¸‹ä¸€æ­¥

1. **ç«‹å³æ‰§è¡Œ**ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬ `./scripts/gitlab-diagnosis.sh`
2. **ç­‰å¾…å¯åŠ¨**ï¼šå¦‚æœæœåŠ¡åˆšå¯åŠ¨ï¼Œç­‰å¾…10-15åˆ†é’Ÿ
3. **æŸ¥çœ‹æ—¥å¿—**ï¼šæ£€æŸ¥ `/var/log/gitlab/gitlab-rails/production.log`
4. **é‡æ–°éªŒè¯**ï¼šè¿è¡Œ `ansible-playbook -i inventory/single-node.yml playbooks/07-verification.yml`
5. **å¦‚æœä»å¤±è´¥**ï¼šå‚è€ƒ `GITLAB_TROUBLESHOOTING.md` è¯¦ç»†æ’æŸ¥

## ğŸ’¡ æç¤º

- ğŸ• **è€å¿ƒç­‰å¾…**ï¼šGitLabé¦–æ¬¡å¯åŠ¨æˆ–é‡å¯åéœ€è¦5-10åˆ†é’Ÿå®Œå…¨å°±ç»ª
- ğŸ“Š **èµ„æºç›‘æ§**ï¼šç¡®ä¿è‡³å°‘æœ‰2GBå¯ç”¨å†…å­˜å’Œ10GBå¯ç”¨ç£ç›˜
- ğŸ”„ **å®šæœŸç»´æŠ¤**ï¼šå®šæœŸæ¸…ç†æ—¥å¿—å’Œå¤‡ä»½æ–‡ä»¶
- ğŸ“– **æŸ¥çœ‹æ–‡æ¡£**ï¼šé‡åˆ°é—®é¢˜å…ˆæŸ¥çœ‹ `GITLAB_TROUBLESHOOTING.md`

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·è¿è¡Œè¯Šæ–­è„šæœ¬å¹¶å°†è¾“å‡ºå‘ç»™æˆ‘ã€‚


