# 部署指南

## 部署前准备

### 1. 环境要求

#### 硬件要求
- **CPU**: 最低 4核，推荐 8核
- **内存**: 最低 8GB，推荐 16GB
- **磁盘**: 最低 100GB，推荐 500GB
- **网络**: 千兆网络

#### 软件要求
- **操作系统**: CentOS 9
- **Python**: 3.8+
- **Ansible**: 2.9+
- **Docker**: 20.10+
- **Kubernetes**: 1.28+

### 2. 网络规划

#### 网络拓扑
```
┌─────────────────────────────────────────┐
│                外部网络                  │
│           192.168.100.0/24              │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│                网关                      │
│           192.168.100.1                  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────┴───────────────────────┐
│                集群网络                  │
│           192.168.1.0/24                │
└─────────────────────────────────────────┘
```

#### IP地址分配
| 节点类型 | 主机名 | IP地址 | 角色 |
|---------|--------|--------|------|
| 控制节点 | control-01 | 192.168.1.10 | 主控制节点 |
| 控制节点 | control-02 | 192.168.1.11 | 备用控制节点 |
| 计算节点 | compute-01 | 192.168.1.20 | 工作节点 |
| 计算节点 | compute-02 | 192.168.1.21 | 工作节点 |
| 计算节点 | compute-03 | 192.168.1.22 | 工作节点 |
| 存储节点 | storage-01 | 192.168.1.30 | 存储节点 |
| 存储节点 | storage-02 | 192.168.1.31 | 存储节点 |
| 监控节点 | monitor-01 | 192.168.1.40 | 监控节点 |
| CI/CD节点 | cicd-01 | 192.168.1.50 | CI/CD节点 |

### 3. 系统配置

#### 主机名配置
```bash
# 在每个节点上设置主机名
hostnamectl set-hostname <hostname>
```

#### 网络配置
```bash
# 配置静态IP
nmcli connection modify "System eth0" ipv4.addresses 192.168.1.10/24
nmcli connection modify "System eth0" ipv4.gateway 192.168.1.1
nmcli connection modify "System eth0" ipv4.dns "8.8.8.8,8.8.4.4"
nmcli connection modify "System eth0" ipv4.method manual
nmcli connection up "System eth0"
```

#### 时间同步
```bash
# 配置NTP
timedatectl set-timezone Asia/Shanghai
systemctl enable chronyd
systemctl start chronyd
```

## 部署步骤

### 1. 准备部署环境

#### 安装Ansible
```bash
# 安装Python和pip
yum install -y python3 python3-pip

# 安装Ansible
pip3 install ansible

# 验证安装
ansible --version
```

#### 配置SSH密钥
```bash
# 生成SSH密钥
ssh-keygen -t rsa -b 4096 -C "your-email@example.com"

# 复制公钥到所有节点
ssh-copy-id root@192.168.1.10
ssh-copy-id root@192.168.1.11
ssh-copy-id root@192.168.1.20
ssh-copy-id root@192.168.1.21
ssh-copy-id root@192.168.1.22
ssh-copy-id root@192.168.1.30
ssh-copy-id root@192.168.1.31
ssh-copy-id root@192.168.1.40
ssh-copy-id root@192.168.1.50
```

### 2. 配置部署参数

#### 编辑inventory文件
```yaml
# inventory/hosts.yml
all:
  children:
    control_nodes:
      hosts:
        control-01:
          ansible_host: 192.168.1.10
          ansible_user: root
        control-02:
          ansible_host: 192.168.1.11
          ansible_user: root
    compute_nodes:
      hosts:
        compute-01:
          ansible_host: 192.168.1.20
          ansible_user: root
        compute-02:
          ansible_host: 192.168.1.21
          ansible_user: root
        compute-03:
          ansible_host: 192.168.1.22
          ansible_user: root
    storage_nodes:
      hosts:
        storage-01:
          ansible_host: 192.168.1.30
          ansible_user: root
        storage-02:
          ansible_host: 192.168.1.31
          ansible_user: root
    monitoring_nodes:
      hosts:
        monitor-01:
          ansible_host: 192.168.1.40
          ansible_user: root
    cicd_nodes:
      hosts:
        cicd-01:
          ansible_host: 192.168.1.50
          ansible_user: root
```

#### 配置变量
```yaml
# group_vars/all.yml
# 网络配置
cluster_network: "192.168.1.0/24"
service_network: "10.96.0.0/12"
pod_network: "10.244.0.0/16"

# 应用配置
app_namespace: "production"
app_name: "web-app"
app_replicas: 3
app_domain: "app.example.com"

# 监控配置
prometheus_port: 9090
grafana_port: 3000
alertmanager_port: 9093

# CI/CD配置
gitlab_port: 80
jenkins_port: 8080
harbor_port: 80
```

### 3. 执行部署

#### 完整部署
```bash
# 执行完整部署
./deploy.sh --mode full

# 或者使用ansible-playbook
ansible-playbook -i inventory/hosts.yml site.yml
```

#### 分步部署
```bash
# 1. 基础环境配置
ansible-playbook -i inventory/hosts.yml playbooks/01-common-setup.yml

# 2. Docker安装
ansible-playbook -i inventory/hosts.yml playbooks/02-docker-setup.yml

# 3. Kubernetes集群
ansible-playbook -i inventory/hosts.yml playbooks/03-kubernetes-setup.yml

# 4. 监控系统
ansible-playbook -i inventory/hosts.yml playbooks/04-monitoring-setup.yml

# 5. CI/CD系统
ansible-playbook -i inventory/hosts.yml playbooks/05-cicd-setup.yml

# 6. 应用部署
ansible-playbook -i inventory/hosts.yml playbooks/06-application-deploy.yml

# 7. 系统验证
ansible-playbook -i inventory/hosts.yml playbooks/07-verification.yml
```

### 4. 验证部署

#### 检查服务状态
```bash
# 检查Docker服务
systemctl status docker

# 检查Kubernetes服务
systemctl status kubelet

# 检查监控服务
systemctl status prometheus
systemctl status grafana-server
systemctl status alertmanager

# 检查CI/CD服务
systemctl status gitlab
systemctl status jenkins
systemctl status harbor
```

#### 检查Kubernetes集群
```bash
# 查看节点状态
kubectl get nodes -o wide

# 查看Pod状态
kubectl get pods --all-namespaces

# 查看服务状态
kubectl get services --all-namespaces

# 查看Ingress状态
kubectl get ingress --all-namespaces
```

#### 检查应用部署
```bash
# 查看应用Pod
kubectl get pods -n production -l app=web-app

# 查看应用服务
kubectl get services -n production -l app=web-app

# 查看应用Ingress
kubectl get ingress -n production -l app=web-app

# 测试应用访问
curl http://app.example.com
```

## 部署后配置

### 1. 配置DNS解析

#### 添加域名解析
```bash
# 在DNS服务器或本地hosts文件中添加
192.168.1.10 app.example.com
192.168.1.40 prometheus.example.com
192.168.1.40 grafana.example.com
192.168.1.50 gitlab.example.com
192.168.1.50 jenkins.example.com
192.168.1.50 harbor.example.com
```

### 2. 配置SSL证书

#### 使用Let's Encrypt
```bash
# 安装certbot
yum install -y certbot python3-certbot-nginx

# 申请证书
certbot --nginx -d app.example.com
certbot --nginx -d prometheus.example.com
certbot --nginx -d grafana.example.com
certbot --nginx -d gitlab.example.com
certbot --nginx -d jenkins.example.com
certbot --nginx -d harbor.example.com
```

### 3. 配置监控告警

#### 配置告警规则
```yaml
# 在Prometheus中配置告警规则
groups:
- name: kubernetes-alerts
  rules:
  - alert: PodCrashLooping
    expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Pod {{ $labels.pod }} is crash looping"
```

#### 配置告警通知
```yaml
# 在Alertmanager中配置通知
receivers:
- name: 'web.hook'
  webhook_configs:
  - url: 'http://127.0.0.1:5001/'
- name: 'email'
  email_configs:
  - to: 'admin@example.com'
    subject: '[ALERT] {{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      {{ end }}
```

### 4. 配置CI/CD流水线

#### 配置GitLab Runner
```bash
# 在GitLab中注册Runner
gitlab-runner register \
  --url http://gitlab.example.com/ \
  --registration-token <token> \
  --executor kubernetes \
  --description "Kubernetes Runner"
```

#### 配置Jenkins Pipeline
```groovy
// Jenkinsfile
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'docker build -t app:${BUILD_NUMBER} .'
            }
        }
        stage('Test') {
            steps {
                sh 'docker run --rm app:${BUILD_NUMBER} npm test'
            }
        }
        stage('Deploy') {
            steps {
                sh 'kubectl set image deployment/web-app web-app=app:${BUILD_NUMBER} -n production'
            }
        }
    }
}
```

## 故障排除

### 1. 常见问题

#### Docker服务启动失败
```bash
# 检查Docker状态
systemctl status docker
journalctl -u docker -f

# 检查Docker配置
cat /etc/docker/daemon.json

# 重启Docker服务
systemctl restart docker
```

#### Kubernetes节点NotReady
```bash
# 检查kubelet状态
systemctl status kubelet
journalctl -u kubelet -f

# 检查网络配置
kubectl get nodes -o wide
kubectl describe node <node-name>

# 检查CNI插件
kubectl get pods -n kube-system -l app=flannel
```

#### Pod启动失败
```bash
# 查看Pod详情
kubectl describe pod <pod-name> -n <namespace>

# 查看Pod日志
kubectl logs <pod-name> -n <namespace>

# 检查资源限制
kubectl top pods -n <namespace>
```

#### 网络连接问题
```bash
# 检查网络连接
ping <target-ip>
telnet <target-ip> <port>

# 检查防火墙状态
firewall-cmd --list-all
firewall-cmd --list-ports

# 检查DNS解析
nslookup <domain>
dig <domain>
```

### 2. 日志分析

#### 系统日志
```bash
# 查看系统日志
journalctl -f
journalctl -u <service-name> -f

# 查看特定时间段的日志
journalctl --since "2024-01-01 00:00:00" --until "2024-01-01 23:59:59"
```

#### 应用日志
```bash
# 查看Pod日志
kubectl logs <pod-name> -n <namespace> -f

# 查看容器日志
docker logs <container-id> -f
```

#### 监控日志
```bash
# 查看Prometheus日志
journalctl -u prometheus -f

# 查看Grafana日志
journalctl -u grafana-server -f

# 查看Alertmanager日志
journalctl -u alertmanager -f
```

### 3. 性能调优

#### 系统优化
```bash
# 调整内核参数
echo 'net.bridge.bridge-nf-call-iptables = 1' >> /etc/sysctl.conf
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
echo 'vm.swappiness = 0' >> /etc/sysctl.conf
sysctl -p

# 优化文件描述符限制
echo '* soft nofile 65536' >> /etc/security/limits.conf
echo '* hard nofile 65536' >> /etc/security/limits.conf
```

#### Kubernetes优化
```yaml
# 资源配置
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# 节点亲和性
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - compute-01
```

## 维护操作

### 1. 日常维护

#### 系统更新
```bash
# 更新系统包
yum update -y

# 更新Docker
yum update docker-ce

# 更新Kubernetes
yum update kubelet kubeadm kubectl
```

#### 备份数据
```bash
# 备份Kubernetes配置
kubectl get all --all-namespaces -o yaml > k8s-backup.yaml

# 备份应用数据
kubectl get configmaps --all-namespaces -o yaml > configmaps-backup.yaml
kubectl get secrets --all-namespaces -o yaml > secrets-backup.yaml
```

#### 清理资源
```bash
# 清理未使用的镜像
docker system prune -a

# 清理未使用的卷
docker volume prune

# 清理Kubernetes资源
kubectl delete pods --field-selector=status.phase=Succeeded
kubectl delete pods --field-selector=status.phase=Failed
```

### 2. 监控维护

#### 检查监控状态
```bash
# 检查Prometheus状态
curl http://localhost:9090/api/v1/query?query=up

# 检查Grafana状态
curl http://localhost:3000/api/health

# 检查Alertmanager状态
curl http://localhost:9093/api/v1/status
```

#### 更新监控配置
```bash
# 更新Prometheus配置
kubectl apply -f prometheus-config.yaml

# 更新Grafana配置
kubectl apply -f grafana-config.yaml

# 更新Alertmanager配置
kubectl apply -f alertmanager-config.yaml
```

### 3. 安全维护

#### 更新证书
```bash
# 更新SSL证书
certbot renew

# 更新Kubernetes证书
kubeadm certs renew all
```

#### 安全扫描
```bash
# 扫描镜像漏洞
trivy image <image-name>

# 扫描Kubernetes配置
kube-score score <config-file>
```

## 扩展部署

### 1. 添加新节点

#### 添加工作节点
```bash
# 在新节点上安装Docker和Kubernetes
ansible-playbook -i inventory/hosts.yml playbooks/02-docker-setup.yml
ansible-playbook -i inventory/hosts.yml playbooks/03-kubernetes-setup.yml

# 加入集群
kubeadm token create --print-join-command
```

#### 添加存储节点
```bash
# 配置存储节点
ansible-playbook -i inventory/hosts.yml playbooks/storage-setup.yml
```

### 2. 配置高可用

#### 配置负载均衡
```bash
# 安装HAProxy
yum install -y haproxy

# 配置HAProxy
cat > /etc/haproxy/haproxy.cfg << EOF
global
    daemon
    user haproxy
    group haproxy

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend kubernetes-frontend
    bind *:6443
    default_backend kubernetes-backend

backend kubernetes-backend
    balance roundrobin
    server control-01 192.168.1.10:6443 check
    server control-02 192.168.1.11:6443 check
EOF

# 启动HAProxy
systemctl enable haproxy
systemctl start haproxy
```

#### 配置数据库高可用
```bash
# 配置PostgreSQL主从复制
# 配置Redis集群
# 配置MongoDB副本集
```

### 3. 配置多集群

#### 配置集群联邦
```bash
# 安装Kubernetes Federation
kubectl apply -f federation-config.yaml

# 配置集群联邦
kubectl apply -f cluster-federation.yaml
```

#### 配置跨集群通信
```bash
# 配置网络策略
kubectl apply -f network-policy.yaml

# 配置服务网格
kubectl apply -f istio-config.yaml
```

---

**注意**: 请确保在生产环境中使用前充分测试所有配置，并定期备份重要数据。
